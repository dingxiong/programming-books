<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Segment Tree - All I know about C++</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../theme/code-details.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">All I know about C++</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="segment-tree"><a class="header" href="#segment-tree">Segment Tree</a></h1>
<p>A segment tree is a binary tree data structure used to efficiently answer range
queries and perform range updates on an array — such as:</p>
<ul>
<li>Range sum</li>
<li>Range minimum/maximum</li>
<li>Range gcd, etc.</li>
</ul>
<p>It’s designed to balance query speed and update speed, both in O(log N) time.</p>
<h2 id="implementation"><a class="header" href="#implementation">Implementation</a></h2>
<p>A few conventions to reduce chances of mistakes.</p>
<ol>
<li>left branch is <code>[l, m]</code>, right branch is <code>[m+1, r]</code>. This avoids the index
of out of range error for the middle point <code>(l+r)/2</code>.</li>
</ol>
<p>Below is the naive implementation using explicit tree node.</p>
<details class="code-details">
<summary> struct Node; </summary>
<pre><code class="language-cpp">struct Node {
    int l, r;
    shared_ptr&lt;Node&gt; left, right;
    int s; // each node stores the sum of the range [l,r].
    Node(int l, int r): l(l), r(r), s(0) {}
};
using NodeP = shared_ptr&lt;Node&gt;;

NodeP root;

void create_children(NodeP node) {
     if (node-&gt;l != node-&gt;r) {
        int m = (node-&gt;l + node-&gt;r) / 2;
        if (not node-&gt;left) node-&gt;left = make_shared&lt;Node&gt;(node-&gt;l, m);
        if (not node-&gt;right) node-&gt;right = make_shared&lt;Node&gt;(m+1, node-&gt;r);
    }
}

int query(NodeP node, int l, int r) {
    int m = (node-&gt;l + node-&gt;r) / 2;
    create_children(node);
    if (node-&gt;l == l and node-&gt;r == r) {
        return node-&gt;s;
    }

    if (r &lt;= m) return search(node-&gt;left, l, r);
    else if (l &gt; m) return search(node-&gt;right, l, r);
    else return search(node-&gt;left, l, m) + search(node-&gt;right, m+1, r);
}

// Add val to the existing value at node i.
void update(NodeP node, int i, int val) {
  create_children();
  node-&gt;s += val;
  if (node-&gt;l == i and node-&gt;r == i) return;
  int m = (node-&gt;l + node-&gt;r) / 2;
  if (i &lt;= m) update(node-&gt;left, i, val);
  else update(node-&gt;right, i, val);
}
</code></pre>
</details>
<p>Most segment tree code you see online uses an array to represent the tree. See
<a href="https://www.hackerearth.com/practice/notes/segment-tree-and-lazy-propagation/">example</a>.
An array <code>int tree[2n+1]</code> represent a tree with <code>n</code> nodes. <code>tree[k]</code> has
children <code>tree[2k]</code> and <code>tree[2k+1]</code>. Root node is <code>tree[1]</code>. However, I do not
like this implementation because it makes the interface more verbose. In my
implementation, <code>struct Node</code> contains the boundary information <code>l</code> and <code>r</code>.
With the array approach, the interface becomes
<code>int query(int node, int start, int end, int l, int r)</code>. The first 3 parameters
are the node index, left and right boundary.</p>
<h2 id="lazy-propagation"><a class="header" href="#lazy-propagation">Lazy Propagation</a></h2>
<p>The basic search and update operation has <code>O(logN)</code> complexity. It is not
efficient for range update. To make it <code>O(logN)</code> as well, we need lazy
propagation. A new helper <code>push</code> introduced. It realized the laziness at the
current node, and push the laziness down to its children. There are four places
we need <code>push</code>. First, at the beginning of a query, which is obvious. Then 3
places in <code>update</code>:</p>
<ol>
<li>At the beginning of <code>update</code>.</li>
<li>At the base condition, i.e., query range equals node's boundary. This is
where the performance improvement comes from. It avoids going deep to leaf
nodes, and simply put a marker in the current node saying: all nodes under
this subtree have an un-realized update amount <code>inc_amount</code>.</li>
<li>Before we finally update current node's value. This is pre-order traversal.
We need to make sure the left and right children do not have any lazy value
before we add them up. Otherwise, it would be wrong. This is most popular
mistake I made!</li>
</ol>
<details class="code-details">
<summary> Lazy Propagation </summary>
<pre><code class="language-cpp">struct Node {
    int l, r;
    shared_ptr&lt;Node&gt; left, right;
    int lazy = 0; // lazy update amount
    int s;
    Node(int l, int r): l(l), r(r), s(0) {}
};
using NodeP = shared_ptr&lt;Node&gt;;

NodeP root;

void create_children(NodeP node) {
     if (node-&gt;l != node-&gt;r) {
        int m = (node-&gt;l + node-&gt;r) / 2;
        if (not node-&gt;left) node-&gt;left = make_shared&lt;Node&gt;(node-&gt;l, m);
        if (not node-&gt;right) node-&gt;right = make_shared&lt;Node&gt;(m+1, node-&gt;r);
    }
}

// realize laziness at current node and push it down the tree.
void push(NodeP node) {
    if (node-&gt;lazy) {
        node-&gt;s += node-&gt;lazy * (node-&gt;r - node-&gt;l + 1);
        // only push down when it is not a leaf node.
        if (node-&gt;l != node-&gt;r) {
            node-&gt;left-&gt;lazy += node-&gt;lazy;
            node-&gt;right-&gt;lazy += node-&gt;lazy;
        }
        // remember to reset laziness.
        node-&gt;lazy = 0;
    }
}

int query(NodeP node, int l, int r) {
    int m = (node-&gt;l + node-&gt;r) / 2;
    create_children(node);
    // realize laziness before query.
    push(node);
    if (node-&gt;l == l and node-&gt;r == r) {
        return node-&gt;s;
    }

    if (r &lt;= m) return search(node-&gt;left, l, r);
    else if (l &gt; m) return search(node-&gt;right, l, r);
    else return search(node-&gt;left, l, m) + search(node-&gt;right, m+1, r);
}

void update(NodeP node, int l, int r, int inc_amount) {
    int m = (node-&gt;l + node-&gt;r) / 2;
    create_children(node);
    push(node);

    if (node-&gt;l == l and node-&gt;r == r) {
        node-&gt;lazy += inc_amount;
        push(node);
        return;
    }
    if (r &lt;= m) {
        insert(node-&gt;left, l, r);
    } else if (l &gt; m) {
        insert(node-&gt;right, l, r);
    } else {
        insert(node-&gt;left, l, m);
        insert(node-&gt;right, m+1, r);
    }
    // make sure left and right do not have un-realized updates.
    push(node-&gt;left); push(node-&gt;right);
    node-&gt;s = node-&gt;left-&gt;s + node-&gt;right-&gt;s;
}
</code></pre>
</details>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../algorithms/graph/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../algorithms/graph/fenwick_tree.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../algorithms/graph/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../algorithms/graph/fenwick_tree.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
